<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- Prevent zooming on mobile and fit screen -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <link rel="icon" href="favicon.svg">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.min.css">
  <title>Leutrim Dema | Full Stack Dev</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 0; margin: 0; }
    nav { padding: 10px 20px; background: #f4f4f4; }
    nav a { margin-right: 15px; text-decoration: none; color: blue; font-size: 1.1em; }
    nav a:hover { text-decoration: underline; }
    ul { padding-left: 0; list-style: none; }
    li { display: flex; align-items: center; gap: 8px; padding: 4px 0; }
    input[type="text"] { flex: 1; padding: 8px; font-size: 1em; }
    button { padding: 8px; font-size: 1em; cursor: pointer; }
    #todo-container { display: flex; gap: 8px; flex-wrap: wrap; }
    #add-btn { background-color: #4CAF50; color: white; border: none; }
    #reset-btn { background-color: #f66; color: white; border: none; }
    .delete-btn { background-color: #ff4444; color: white; border: none; padding: 4px 8px; margin-left: 8px; }
    .completed { text-decoration: line-through; opacity: 0.7; }
    .loading { opacity: 0.5; }
    .error { color: #ff4444; margin: 10px 0; }
    .resume-container iframe { width: 100%; height: 100vh; border: none; }
    @media (max-width: 500px) {
      nav a { display: inline-block; margin-bottom: 10px; }
      #todo-container { flex-direction: column; gap: 6px; }
      input[type="text"], button { width: 100%; box-sizing: border-box; }
    }
  </style>
</head>
<body>
  <nav>
    <a href="./" data-link>Home</a>
    <a href="./todo" data-link>Todo</a>
  </nav>

  <div id="app"></div>

  <script>
    // API Configuration - Replace with your actual Render backend URL
    const API_BASE = 'https://website-backend-knvy.onrender.com/api';
    
    // Handle redirect from 404.html (skip if local file)
    if (location.protocol !== "file:") {
      const params = new URLSearchParams(window.location.search);
      if (params.has("redirect")) {
        history.replaceState(null, "", params.get("redirect"));
      }
    }

    // API Functions
    async function apiRequest(endpoint, options = {}) {
      try {
        const response = await fetch(`${API_BASE}${endpoint}`, {
          headers: {
            'Content-Type': 'application/json',
            ...options.headers
          },
          ...options
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        return await response.json();
      } catch (error) {
        console.error('API request failed:', error);
        throw error;
      }
    }

    async function getTodos() {
      return await apiRequest('/todos');
    }

    async function createTodo(title, description = '') {
      return await apiRequest('/todos', {
        method: 'POST',
        body: JSON.stringify({ title, description })
      });
    }

    async function toggleTodo(id) {
      return await apiRequest(`/todos/${id}/toggle`, {
        method: 'PATCH'
      });
    }

    async function deleteTodo(id) {
      return await apiRequest(`/todos/${id}`, {
        method: 'DELETE'
      });
    }

    function renderHome() {
      document.getElementById("app").innerHTML = `
        <div class="resume-container">
          <iframe src="./LEUTRIM DEMA RESUME 2025.pdf"></iframe>
        </div>
      `;
    }

    async function renderTodo() {
      document.getElementById("app").innerHTML = `
        <h1>Todo App</h1>
        <div id="error-message" class="error" style="display: none;"></div>
        <div id="todo-container">
          <input type="text" id="todo-input" placeholder="Enter a task" />
          <button id="add-btn">Add</button>
          <button id="reset-btn">Clear All</button>
        </div>
        <div id="loading" class="loading" style="display: none;">Loading...</div>
        <ul id="todo-list"></ul>
      `;

      const input = document.getElementById("todo-input");
      const list = document.getElementById("todo-list");
      const errorDiv = document.getElementById("error-message");
      const loadingDiv = document.getElementById("loading");

      function showError(message) {
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        setTimeout(() => {
          errorDiv.style.display = 'none';
        }, 5000);
      }

      function showLoading(show) {
        loadingDiv.style.display = show ? 'block' : 'none';
      }

      async function loadTodos() {
        try {
          showLoading(true);
          const todos = await getTodos();
          renderTodoList(todos);
        } catch (error) {
          showError('Failed to load todos. Please check your connection.');
        } finally {
          showLoading(false);
        }
      }

      function renderTodoList(todos) {
        list.innerHTML = '';
        todos.forEach(todo => {
          const li = document.createElement("li");
          
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.checked = todo.completed;
          checkbox.addEventListener("change", async () => {
            try {
              await toggleTodo(todo.id);
              span.classList.toggle('completed', checkbox.checked);
            } catch (error) {
              checkbox.checked = !checkbox.checked; // Revert on error
              showError('Failed to update todo');
            }
          });

          const span = document.createElement("span");
          span.textContent = todo.title;
          if (todo.completed) {
            span.classList.add('completed');
          }

          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "×";
          deleteBtn.className = "delete-btn";
          deleteBtn.addEventListener("click", async () => {
            try {
              await deleteTodo(todo.id);
              li.remove();
            } catch (error) {
              showError('Failed to delete todo');
            }
          });

          li.appendChild(checkbox);
          li.appendChild(span);
          li.appendChild(deleteBtn);
          list.appendChild(li);
        });
      }

      document.getElementById("add-btn").onclick = async () => {
        const task = input.value.trim();
        if (task) {
          try {
            const newTodo = await createTodo(task);
            input.value = "";
            
            // Add to DOM immediately for better UX
            const li = document.createElement("li");
            
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.addEventListener("change", async () => {
              try {
                await toggleTodo(newTodo.id);
                span.classList.toggle('completed', checkbox.checked);
              } catch (error) {
                checkbox.checked = !checkbox.checked;
                showError('Failed to update todo');
              }
            });

            const span = document.createElement("span");
            span.textContent = newTodo.title;

            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "×";
            deleteBtn.className = "delete-btn";
            deleteBtn.addEventListener("click", async () => {
              try {
                await deleteTodo(newTodo.id);
                li.remove();
              } catch (error) {
                showError('Failed to delete todo');
              }
            });

            li.appendChild(checkbox);
            li.appendChild(span);
            li.appendChild(deleteBtn);
            list.prepend(li); // Add to top of list
            
          } catch (error) {
            showError('Failed to add todo');
          }
        }
      };

      document.getElementById("reset-btn").onclick = async () => {
        if (confirm('Are you sure you want to clear all todos?')) {
          try {
            const todos = await getTodos();
            await Promise.all(todos.map(todo => deleteTodo(todo.id)));
            list.innerHTML = "";
          } catch (error) {
            showError('Failed to clear todos');
          }
        }
      };

      // Allow Enter key to add todo
      input.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          document.getElementById("add-btn").click();
        }
      });

      // Load todos when page loads
      await loadTodos();
    }

    function router() {
      let path = window.location.pathname;
      if (location.protocol === "file:") {
        path = location.hash.replace("#", "") || "/";
      }
      if (path.endsWith("todo") || path === "/todo" || path === "todo") {
        renderTodo();
      } else {
        renderHome();
      }
    }

    document.addEventListener("click", (e) => {
      if (e.target.matches("[data-link]")) {
        e.preventDefault();
        if (location.protocol === "file:") {
          location.hash = e.target.getAttribute("href").replace("./", "");
        } else {
          history.pushState(null, "", e.target.href);
          router();
        }
      }
    });

    window.addEventListener("popstate", router);
    window.addEventListener("load", router);
  </script>
</body>
</html>